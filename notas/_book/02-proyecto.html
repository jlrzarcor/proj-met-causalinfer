<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>INVESTIGACIÓN SOBRE MÉTODOS DE PREDICCIÓN EN SERIES DE TIEMPO JERÁRQUICAS O AGRUPADAS - 2&nbsp; Tipos de estructuras que surgen en datos desagregados</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03-proyecto.html" rel="next">
<link href="./01-proyecto.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tipos de estructuras que surgen en datos desagregados</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">INVESTIGACIÓN SOBRE MÉTODOS DE PREDICCIÓN EN SERIES DE TIEMPO JERÁRQUICAS O AGRUPADAS</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Inicio</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción y Definición del Problema</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-proyecto.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tipos de estructuras que surgen en datos desagregados</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Enfoque tradicional de predicciones a un nivel de agregación</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Reconciliación en las Predicciones</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Predicciones para resolver el Problema de Ventas</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#series-de-tiempo-jerárquicas" id="toc-series-de-tiempo-jerárquicas" class="nav-link active" data-scroll-target="#series-de-tiempo-jerárquicas"><span class="toc-section-number">2.1</span>  Series de Tiempo Jerárquicas</a></li>
  <li><a href="#series-de-tiempo-agrupadas" id="toc-series-de-tiempo-agrupadas" class="nav-link" data-scroll-target="#series-de-tiempo-agrupadas"><span class="toc-section-number">2.2</span>  Series de Tiempo Agrupadas</a></li>
  <li><a href="#estructura-mixta-jerárquica-y-agrupada" id="toc-estructura-mixta-jerárquica-y-agrupada" class="nav-link" data-scroll-target="#estructura-mixta-jerárquica-y-agrupada"><span class="toc-section-number">2.3</span>  Estructura Mixta Jerárquica y Agrupada</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tipos de estructuras que surgen en datos desagregados</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>En las series de tiempo (datos secuenciales) una de las características principales es su natural estructura compleja de <em>autocorrelación</em> que implica que las observaciones no son independientes. En general, presentan patrones de tendencia, ciclicidad o autocorrelación que requieren un entendimiento profundo para poder analizar correctamente la serie, ya sea para realizar descripción e inferencia acerca de su estructura o para generar predicciones acerca de valores futuros.</p>
<p>Los modelos de espacio de estados (bayesianos dinámicos) nos permite modelar la estructura de una serie de tiempo de forma modular, además:</p>
<ul>
<li>Mayor flexibilidad en cuanto a las estructuras que podemos usar, y cómo usar información acerca de la dinámica de la serie de tiempo (incluyendo aspectos de modelos ARIMA).</li>
<li>Una forma estándar de tratar con valores faltantes, series irregulares, o varias observaciones contemporáneas.</li>
<li>Una forma estándar de producir pronósticos puntuales, en intervalos, o por distribuciones.</li>
<li>Una forma estándar de permitir que el modelo se adapte en el tiempo a cambios estructurales (por ejemplo, cambios de patrones de estacionalidad, efectos diferentes de covariables, etc.)</li>
</ul>
<p>Por otro lado, regularmente las series de tiempo pueden estar desagregadas por diversos atributos específicos de interés para el investigador. Tales atributos podrían desagregarse a su vez en categorías o subcategorías más detalladas, esto es, categorías anidadas en categorías de grupos de mayor tamaño, por lo que a esta estructura de agregación jerárquica en las series de tiempo le llamamos naturalmente <strong>“Series de Tiempo Jerárquicas”</strong>, que usualmente resultan a causa de las divisiones geográficas.</p>
<p>Una estructura de agregación más compleja aún surge cuando podemos utilizar dos categorías jerárquicas juntas, e.g.&nbsp;jerarquías por producto y por región geográfica. En este caso se le conoce como <strong>“Series de Tiempo Agrupadas”</strong></p>
<p>Para complementar e ilustrar nuestra investigación sobre Predicción en Modelos de Series de Tiempo Jerárquicas, se decidió utilizar siguiente dataset de Kaggle <a href="https://www.kaggle.com/competitions/tabular-playground-series-sep-2022/data">Tabular Playground Series Sep2022</a> El objetivo consiste en predecir un año completo de ventas para 4 artículos de 2 tiendas en 6 distintos países, por lo que, de acuerdo a lo comentado anteriormente, es una serie de tiempo con estructura jerárquica. (ver sección 1 para ampliar información sobre el <em>dataset</em>). El siguiente diagrama nos permite visualizar tal estructura:</p>
<p><img src="figuras/series_de_tiempo_hierarchical.jpg" class="img-fluid"></p>
<p>Usualmente generamos predicciones desagregadas a partir de series de tiempo desagregadas y requerimos que tales predicciones se adicionen en la misma forma que la estructura en los datos. En nuestro ejemplo, las predicciones de cada tienda se adicionan para generar la predicción de cada país y éstas a su vez para generar la predicción de ventas total.</p>
<p>Nuestro objetivo es presentar y discutir los métodos de predicción para colecciones de series de tiempo jerárquicas bajo el reto que tales predicciones guarden congruencia a través de la estructura de agregación.</p>
<section id="series-de-tiempo-jerárquicas" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="series-de-tiempo-jerárquicas"><span class="header-section-number">2.1</span> Series de Tiempo Jerárquicas</h2>
<p>Esencialmente, estas series se organizan en una estructura por niveles, siendo el nivel 0 la jerarquía más alta, es decir, el nivel de mayor agregación de los datos.</p>
<p>La siguiente figura nos permitira conceptualizar de forma intuitiva las estructuras jerárquicas y servirá como base para construir las ecuaciones y notación necesaria.</p>
<p><img src="figuras/diagram_hierarchical.png" class="img-fluid"> <em>Figura A: diagrama para series de tiempo jerárquicas</em></p>
<div class="cell">

</div>
<p>Denotemos la <span class="math inline">\(t\)</span>th observación por <span class="math inline">\(y_{t}\)</span> donde <span class="math inline">\(t=1,...,T\)</span>. En el gráfico anterior podemos osbervar que la estructura jerárquica nos muestra que el Total está desagregado en 2 series <span class="math inline">\(A\)</span> y <span class="math inline">\(B\)</span> en el nivel 1, que a su vez se desagregan en 3 y 2 series respectivamente en el nivel más bajo. Esto implica que tenemos 8 (1, 2, 5) series, con 5 en el último nivel de la jerarquía.</p>
<p>Para cualquier tiempo <span class="math inline">\(t\)</span>, las observaciones en el último nivel inferior de la jerarquía deben sumar con las observaciones de las series superiores. Por tanto, podemos construir ecuaciones de agregación restricta (por llamarles de alguna forma):</p>
<p><span class="math display">\[
\begin{align}
\tag{2.1.1}
y_{t}=y_{\text{AA},t}+y_{\text{AB},t}+y_{\text{AC},t}+y_{\text{BA},t}+y_{\text{BB},t}
\end{align}
\]</span></p>
<p>equivalente a:</p>
<p><span class="math display">\[
\begin{align}
\tag{2.1.2}
y_{t}=y_{\text{A},t}+y_{\text{B},t}
\end{align}
\]</span></p>
<p>con</p>
<p><span class="math display">\[
\begin{align}
\tag{2.1.3}
y_{\text{A},t}=y_{\text{AA},t}+y_{\text{AB},t}+y_{\text{AC},t} \quad \text{y} \quad
y_{\text{B},t}=+y_{\text{BA},t}+y_{\text{BB},t}
\end{align}
\]</span></p>
<p>Por practicidad, es recomendable que utilicemos una notación matricial (por ser más compacta). Básicamente, buscamos una matriz que induzca la forma en que las series inferiores deben agregarse. Para ello, contruimos una matriz de acumulación <span class="math inline">\(S\)</span> de orden <span class="math inline">\(n \times m\)</span> de la siguiente forma (con base a la estructura de nuestro ejemplo):</p>
<p><span class="math display">\[
\begin{bmatrix}
    y_{t} \\
    y_{\text{A},t} \\
    y_{\text{B},t} \\
    y_{\text{AA},t} \\
    y_{\text{AB},t} \\
    y_{\text{AC},t} \\
    y_{\text{BA},t} \\
    y_{\text{BB},t}
  \end{bmatrix}
  =
  \begin{bmatrix}
    1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 \\
    1 &amp; 1 &amp; 1 &amp; 0 &amp; 0 \\
    0 &amp; 0 &amp; 0 &amp; 1 &amp; 1 \\
    1  &amp; 0  &amp; 0  &amp; 0  &amp; 0  \\
    0  &amp; 1  &amp; 0  &amp; 0  &amp; 0  \\
    0  &amp; 0  &amp; 1  &amp; 0  &amp; 0  \\
    0  &amp; 0  &amp; 0  &amp; 1  &amp; 0  \\
    0  &amp; 0  &amp; 0  &amp; 0  &amp; 1
  \end{bmatrix}
  \begin{bmatrix}
    y_{\text{AA},t} \\
    y_{\text{AB},t} \\
    y_{\text{AC},t} \\
    y_{\text{BA},t} \\
    y_{\text{BB},t}
  \end{bmatrix}
\]</span></p>
<p>cuya ecuación queda definida por:</p>
<p><span class="math display">\[
\begin{align}
\tag{2.1.4}
\boldsymbol{y}_t=\boldsymbol{S}\boldsymbol{b}_{t},
\end{align}
\]</span></p>
<p>donde:</p>
<ul>
<li><span class="math inline">\(\boldsymbol{y}_t\)</span>: vector <span class="math inline">\(n\)</span>-dimensional con todas las observaciones de la jerarquía en el tiempo <span class="math inline">\(t\)</span>.<br>
</li>
<li><span class="math inline">\(\boldsymbol{S}\)</span>: matriz de acumulación.<br>
</li>
<li><span class="math inline">\(\boldsymbol{b}_t\)</span>: es un vector <span class="math inline">\(m\)</span>-dimensional de las observaciones en el nivel último inferior de la jerarquía.</li>
</ul>
<p><em>¿Qué representa nuestra matriz, cómo induce las relaciones de jerarquía, cómo se construye?</em>.</p>
<ol type="1">
<li>La primer fila de la matriz representa la ecuación (2.1.1), la serie en el nivel más alto de la jerarquía.</li>
<li>En este caso, la segunda y tercer fila representan (2.1.3) correspondientes a las series <span class="math inline">\(A\)</span> y <span class="math inline">\(B\)</span> para el nivel 2 de nuestro ejemplo.</li>
<li><span class="math inline">\(\vdots\)</span> (similar al nivel 2, se construyen niveles adicionales inferiores hasta llegar al penúltimo nivel).</li>
</ol>
<ol start="14" type="a">
<li>El último nivel deberá ser presentado por una matriz identidad <span class="math inline">\(I_m\)</span>.</li>
</ol>
<p><strong>Ejemplo. Kaggle Tabular Playground Series - Sep 2022</strong></p>
<p>Como mencionamos en la sección 1, los datos corresponden a 6 países que a su vez poseen 2 tiendas (que compiten) y las cuales comercializan 4 productos de interés para los accionistas. El área de desarrollo comercial y presupuesto está interesada en conocer el valor de las ventas totales para 2021 en la región Europea; así mismo, desean conocer los ventas por producto, por tienda y por país para determinar el nivel de producción requerido por país garantizando que no exista desabasto ni sobreinventario (esto se analizará en series de tiempo agrupadas); finalmente, es requerido analizar la rentabilidad que se espera por tienda.</p>
<p>Como bien sabemos, la paquetería <code>fpp3</code> adapta los principios <em>tidy</em> al procesamiento de datos. Por lo que, lo primero que haremos es transfomar nuestro <em>dataset</em> a un tabla de datos para serie de tiempo denominada <code>tsibble</code> (time series tibble).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="ot">&lt;-</span> sales <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">t =</span> (<span class="fu">year</span>(date)<span class="sc">-</span><span class="fu">year</span>(<span class="fu">min</span>(date)))<span class="sc">*</span><span class="dv">12</span> <span class="sc">+</span> (<span class="fu">month</span>(date)<span class="sc">-</span><span class="fu">month</span>(<span class="fu">min</span>(date)))) <span class="sc">|&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">yearmonth</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date,t,country,store,product) <span class="sc">|&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tsibble</span>(<span class="at">index =</span> date,<span class="at">key =</span> <span class="fu">c</span>(country,store,product))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'date', 't', 'country', 'store'. You can
override using the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sales_m,<span class="dv">2</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 13%">
<col style="width: 4%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 40%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: right;">t</th>
<th style="text-align: left;">country</th>
<th style="text-align: left;">store</th>
<th style="text-align: left;">product</th>
<th style="text-align: right;">num_sold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017 Jan</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Belgium</td>
<td style="text-align: left;">KaggleMart</td>
<td style="text-align: left;">Kaggle Advanced Techniques</td>
<td style="text-align: right;">13345</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017 Feb</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Belgium</td>
<td style="text-align: left;">KaggleMart</td>
<td style="text-align: left;">Kaggle Advanced Techniques</td>
<td style="text-align: right;">12556</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>La función <code>aggregate_key()</code> se utiliza para crear series de tiempo jerárquicas; para especificar si corresponde a una estructura anidada utilizamos la notación <code>parent/child</code>. Esto genera filas adicionales a nuestro <code>tsibble</code> que corresponden a las observaciones de agregación generados para cada periodo.</p>
<p><strong>Análisis de la tendencia</strong></p>
<p>Analizaremos las tendencias de las ventas totales para todo Europa y desagregadas por país, luego por tienda y finalente por producto.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>(country<span class="sc">/</span>store<span class="sc">/</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is_aggregated</span>(store)) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(num_sold) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: Europa y por país"</span>) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(country), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Observamos un patrón cíclico de pico muy cercano al final del año que en particular en 2019 en algunos países se observó justo en el final del año (excepto en Belgium y Germany). Coincidentemente con la pandemia, se tuvo una caída abrupta en las ventas para todos los países durante el primer trimestre de 2020 y una tendencia de recuperación en el nivel de ventas posterior a este trimestre.</p>
<p>En terminos generales, se observa una tendencia decreciente durante el año con un repentino incremento hacia el final del mismo, por lo que será relevante observar el comportamiento de la estacionalidad.</p>
<p>A gran escala, todos los países tuvieron un incremento considerable en las ventas en comparación con 2017, no obstante todos muestran una tendencia decreciente durante 2018 y 2019.</p>
<p>Otro elemento adicional, es que podemos observar dos patrones muy bien definidos del comportamiento de las ventas que surgen en lo que podríamos considerar 2 regiones: 1. Región norte de Europa: France, Belgium y Germany. Una caída severa de sus niveles de ventas durante el primer trimestre de 2020 (niveles cercanos 0) con una recuperación durante los siguientes trimestres casi a niveles previos a la caída del primer trimestre. 2. Región sur de Europa: Poland, Italy y Spain. Un cambio abrupto en el nivel de ventas a partir de 2020, en particular Poland con un incremento del 250% y un incremento de aproximadamente un 40% para Italy y Spain. El impacto por la caída en en el primer trimestre fue moderado para los tres países.</p>
<p>A nivel Nacional, observamos que el patrón de tendencia se rige en su mayoría por el comportamiento de la región sur, en particular en el fuete incremento que se experimentó en 2020.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>(store<span class="sc">/</span>country<span class="sc">/</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is_aggregated</span>(country)) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(num_sold) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: Europa y por tienda"</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(store), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>El comporatmiento entre ambas tiendas es prácticamente el mismo pero a escalas diferentes, por lo que el agregado de Europa guarda este mismo patrón.</p>
<p>Como era de esperarse, en comparación con lo observado por país, observamos los mismos elementos en las tres series: 1. Incremento significativo en el nivel de ventas para 2018 y 2019 en comparación con 2017; 2. Tendencia decreciente de 2018 a 2019; 3. Máximo histórico observado a finales de 2019 con una abrupta caída en el primer trimestre de 2020 y una tendencia de recuperación durante los siguientes trimestres para superar nuevamente el nivel de ventas histórico para el cierre del año 2020.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>(product<span class="sc">/</span>store<span class="sc">/</span>country, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is_aggregated</span>(store)) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(num_sold) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: Europa y por producto"</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(product), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finalmente, cuando observamos la tendencia por producto observmos que en general tienen un comportamiento creciente y fuertemente estacional, excepto <em>One Smart Goose</em> que muestra un patron fluctuante (no estacionalidad visible), una tendencia creciente con una caída fuerte en 2019 y una recuperación en 2020.</p>
<p><strong>Análisis de estacionalidad</strong></p>
<p>Anteriormente, ya observamo ciertos comportamientos estacionales en el análisis de tendencia, en particular nos interes la estacionalidad por producto y por país.</p>
<p>En el caso por producto, esperaríamos cierto comportamiento bien definido en la mayoría de los productos. En el análisis por país, de acuerdo a lo observado en la tendencia, consideramos que es factible obtener ciertos comportamientos bien definidos por la región norte y la región sur.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>(country<span class="sc">/</span>store<span class="sc">/</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is_aggregated</span>(store)) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>store) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">country =</span> <span class="fu">factor</span>(country)) <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg_season</span>(num_sold) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(country), <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes"</span>,<span class="at">y =</span> <span class="st">"Ventas (miles)"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>De forma consistente con el análisis de tendencia, los patrones de comportamiento estacional se encuentran bien definidos por las regiones mencionadas anteriormente, así como un dominio de la región norte con el agregado de todo Europa.</p>
<p>Aspectos que resaltan claramente con respecto al año 2020 y debemos tener presente son:</p>
<ul>
<li>El comportamiento de la región norte en ausencia del 2020, tiene sus niveles de venta más altos tanto en los días alrededor del principio y fin de año así como durante el segundo trimestre (abril-junio). Visualmente podríamos establecer que sus valores promedio mensuales estarían en el rango entre 50 y 60.</li>
<li>Para la región sur (Italy, Poland, Spain), también en asuencia de 2020 el patrón de comportamiento estacional es muy similar a la región norte pero con la diferencia de ser más bajo, con valores medios mernsuales entre 20 y 40.</li>
<li>Finalmente, el 2020 muestra un cambio fuerte en los niveles de venta de la región sur, casi similar al observado en la región norte.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>(product<span class="sc">/</span>store<span class="sc">/</span>country, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is_aggregated</span>(store)) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>store) <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">product =</span> <span class="fu">factor</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg_season</span>(num_sold) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(product), <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)<span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes"</span>,<span class="at">y =</span> <span class="st">"Ventas (miles)"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>El gráfico anterior muestra un comportamiento estacional perfectamente bien definido por cada producto, incluso 2020 en general mantiene este comportamiento pero incrementado en sus niveles de venta y con el claro impacto de caída durante el primer trimestre del 2020 y tendencia creciente durante los trimestres subsecuentes.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p>Es necesario indicar que no se tiene información suficiente para poder determinar a qué obedece este crecimiento en los niveles de venta durante 2020; observamos que el crecimiento en las ventas puede obedecer a mayor ventas en los productos, pero esto también puede estar determinado por un crecimiento en tiendas en los países de las región sur que es donde se observó el creimiento.</p>
</div>
</div>
</section>
<section id="series-de-tiempo-agrupadas" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="series-de-tiempo-agrupadas"><span class="header-section-number">2.2</span> Series de Tiempo Agrupadas</h2>
<p>En este caso, los datos no tienen una forma jerárquica de desagregarse naturalmente. La siguiente figura es un ejemplo simple para una estructura agrupada.</p>
<p><img src="figuras/diagram_grouped.png" class="img-fluid"> <em>Figura B: diagrama para series de tiempo agrupadas</em></p>
<div class="cell">

</div>
<p>Observemos que en estas estructuras existen formas alternativas de agregación. En el ejemplo anterior, la agregación de <span class="math inline">\(X\)</span> y <span class="math inline">\(Y\)</span> es alternativa con <span class="math inline">\(A\)</span> y <span class="math inline">\(B\)</span>.</p>
<p>Continuando con el ejemplo del gráfico, tenemos entonces que para cualquier tiempo <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[
\begin{align}
  \tag{2.2.1}
  y_{t}=y_{\text{AX},t}+y_{\text{AY},t}+y_{\text{BX},t}+y_{\text{BY},t}
\end{align}
\]</span></p>
<p>Para el primer nivel de la estructura agrupada:</p>
<p><span class="math display">\[
\begin{align}
  \tag{2.2.2}
  y_{\text{A},t}=y_{\text{AX},t}+y_{\text{AY},t}  \quad \quad
  y_{\text{B},t}=y_{\text{BX},t}+y_{\text{BY},t}
\end{align}
\]</span></p>
<p>No obstante, obervemos que alternativamente también se tiene:</p>
<p><span class="math display">\[
\begin{align}
  \tag{2.2.3}
  y_{\text{X},t}=y_{\text{AX},t}+y_{\text{BX},t}  \quad \quad
  y_{\text{Y},t}=y_{\text{AY},t}+y_{\text{BY},t}
\end{align}
\]</span></p>
<p>De forma análoga a la construcción de notación matricial en el caso jerárquico, construimos una matriz de acumulación <span class="math inline">\(S\)</span> de orden <span class="math inline">\(n \times m\)</span>:</p>
<p><span class="math display">\[
\begin{bmatrix}
    y_{t} \\
    y_{\text{A},t} \\
    y_{\text{B},t} \\
    y_{\text{X},t} \\
    y_{\text{Y},t} \\
    y_{\text{AX},t} \\
    y_{\text{AY},t} \\
    y_{\text{BX},t} \\
    y_{\text{BY},t}
  \end{bmatrix}
  =
  \begin{bmatrix}
    1 &amp; 1 &amp; 1 &amp; 1 \\
    1 &amp; 1 &amp; 0 &amp; 0 \\
    0 &amp; 0 &amp; 1 &amp; 1 \\
    1 &amp; 0 &amp; 1 &amp; 0 \\
    0 &amp; 1 &amp; 0 &amp; 1 \\
    1  &amp; 0  &amp; 0  &amp; 0  \\
    0  &amp; 1  &amp; 0  &amp; 0  \\
    0  &amp; 0  &amp; 1  &amp; 0  \\
    0  &amp; 0  &amp; 0  &amp; 1
  \end{bmatrix}
  \begin{bmatrix}
    y_{\text{AX},t} \\
    y_{\text{AY},t} \\
    y_{\text{BX},t} \\
    y_{\text{BY},t}
  \end{bmatrix}
\]</span> cuya ecuación queda definida por:</p>
<p><span class="math display">\[
\begin{align}
  \tag{2.2.4}
  \boldsymbol{y}_t=\boldsymbol{S}\boldsymbol{b}_{t},
\end{align}
\]</span></p>
<p>donde:</p>
<ul>
<li><span class="math inline">\(\boldsymbol{y}_t\)</span>: vector <span class="math inline">\(n\)</span>-dimensional con todas las observaciones de la jerarquía en el tiempo <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(\boldsymbol{S}\)</span>: matriz de acumulación</li>
<li><span class="math inline">\(\boldsymbol{b}_t\)</span>: es un vector <span class="math inline">\(m\)</span>-dimensional de las observaciones en el nivel último inferior de la jerarquía.</li>
</ul>
<p><em>¿Qué representa nuestra matriz, cómo induce las relaciones de jerarquía, cómo se construye?</em></p>
<ol type="1">
<li>La primer fila de la matriz representa la ecuación (2.2.1), la serie en el nivel más alto de la jerarquía</li>
<li>En este caso, la segunda y tercer fila representan la ecuación (2.2.2) correspondientes a las series <span class="math inline">\(A\)</span> y <span class="math inline">\(B\)</span> para el nivel 2 de nuestro ejemplo.</li>
<li>En este caso, cuarta y quinta fila representan la ecuación (2.2.3) correspondientes a las series <span class="math inline">\(X\)</span> y <span class="math inline">\(Y\)</span> para el nivel 2 de nuestro ejemplo.</li>
<li><span class="math inline">\(\vdots\)</span> (similar al nivel 2, se construyen niveles adicionales inferiores hasta llegar al penúltimo nivel)</li>
</ol>
<ol start="14" type="a">
<li>El último nivel deberá ser presentado por una matriz identidad <span class="math inline">\(I_m\)</span>.</li>
</ol>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Las series de tiempo agrupadas pueden interpretarse como series jerárquicas sin la restricción de una estructura única, esto es el órden de agrupación no es único</strong></p>
</div>
</div>
<p><strong>Ejemplo. Kaggle Tabular Playground Series - Sep 2022. Enfoque Serie de Tiempo Agrupadas</strong></p>
<p>En la sección 2.1 sobre series de tiempo jerárquicas, describimos previamente los objetivos del área comercial e identificamos uno particularmente interesante que corresponde a series de tiempo agrupadas, el conocer los niveles de venta por país, tienda y producto para garantizar un invenatario óptimo.</p>
<p>Para crear series de tiempo agrupadas utilizando la paquetería <code>fpp3</code>, también utilizamos la funcion <code>aggregate_key()</code> para definir atributos o grupos de interés cruzados bajo la sintaxis <code>attributo1*atributo2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>( country<span class="sc">*</span>store<span class="sc">*</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is_aggregated</span>(country), <span class="sc">!</span><span class="fu">is_aggregated</span>(store), <span class="sc">!</span><span class="fu">is_aggregated</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(num_sold) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: por país, tienda y producto"</span>) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(country), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>( country<span class="sc">*</span>store<span class="sc">*</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is_aggregated</span>(country), <span class="sc">!</span><span class="fu">is_aggregated</span>(store), <span class="sc">!</span><span class="fu">is_aggregated</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">store =</span> <span class="fu">as.character</span>(store),<span class="at">product =</span> <span class="fu">as.character</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> num_sold, <span class="at">group =</span> store, <span class="at">colour =</span> store)) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> sum, <span class="at">geom =</span> <span class="st">"line"</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: por país, tienda y producto"</span>) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">as.character</span>(country), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>( country<span class="sc">*</span>store<span class="sc">*</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is_aggregated</span>(country), <span class="sc">!</span><span class="fu">is_aggregated</span>(store), <span class="sc">!</span><span class="fu">is_aggregated</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">store =</span> <span class="fu">as.character</span>(store),<span class="at">product =</span> <span class="fu">as.character</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> num_sold, <span class="at">group =</span> product, <span class="at">colour =</span> product)) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> sum, <span class="at">geom =</span> <span class="st">"line"</span>) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: por país, tienda y producto"</span>) <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">as.character</span>(country), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="estructura-mixta-jerárquica-y-agrupada" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="estructura-mixta-jerárquica-y-agrupada"><span class="header-section-number">2.3</span> Estructura Mixta Jerárquica y Agrupada</h2>
<p>Ahora bien, es posible que en algunos casos los factores de desagregación estén tanto anidados como cruzados (intersectados) al mismo tiempo, por lo que nuestra estructura es mixta, jerárquica y agrupada al mismo tiempo.</p>
<p>Continuemos con nuestro caso de estudio de los datos de Ventas de productos en países europeos (Kaggle), los datos pueden desagregarse en los 4 productos sin necesidad de anidarse en cualquiera de las otras variables, país o tienda, esto es, podemos analizar nuestros datos o hacer predicciones por producto para toda la región europea con presencia comercial, pero también es posible realizar esto por cada país y por cada tienda. Se define esta estructura como <strong>anidación</strong> de geografía jerárquica <strong>cruzada</strong> o “intersectada” con el producto.</p>
<p>Continuando con el uso del paquete de los autores <code>fpp3</code>, lo anterior se implementa combinando factores utilizando la función <code>aggregate_key()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>((country <span class="sc">/</span> store) <span class="sc">*</span> product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is_aggregated</span>(country), <span class="fu">is_aggregated</span>(store), <span class="sc">!</span><span class="fu">is_aggregated</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(num_sold) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales por producto"</span>) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(product), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sales_m <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggregate_key</span>((country<span class="sc">/</span>store)<span class="sc">*</span>product, <span class="at">num_sold =</span> <span class="fu">sum</span>(num_sold,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is_aggregated</span>(country), <span class="sc">!</span><span class="fu">is_aggregated</span>(store), <span class="sc">!</span><span class="fu">is_aggregated</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">store =</span> <span class="fu">as.character</span>(store),<span class="at">product =</span> <span class="fu">as.character</span>(product)) <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> num_sold, <span class="at">group =</span> product, <span class="at">colour =</span> product)) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> sum, <span class="at">geom =</span> <span class="st">"line"</span>) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mes/Año"</span> , <span class="at">y =</span> <span class="st">"Ventas (miles)"</span>,<span class="at">title =</span> <span class="st">"Ventas totales: por país y producto"</span>) <span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">as.character</span>(country), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-proyecto_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./01-proyecto.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción y Definición del Problema</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03-proyecto.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Enfoque tradicional de predicciones a un nivel de agregación</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>