<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>INVESTIGACIÓN SOBRE MÉTODOS DE PREDICCIÓN EN SERIES DE TIEMPO JERÁRQUICAS O AGRUPADAS - 5&nbsp; Predicciones para resolver el Problema de Ventas</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./99-referencias.html" rel="next">
<link href="./04-proyecto.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Predicciones para resolver el Problema de Ventas</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">INVESTIGACIÓN SOBRE MÉTODOS DE PREDICCIÓN EN SERIES DE TIEMPO JERÁRQUICAS O AGRUPADAS</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Inicio</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción y Definición del Problema</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tipos de estructuras que surgen en datos desagregados</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Enfoque tradicional de predicciones a un nivel de agregación</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-proyecto.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Reconciliación en las Predicciones</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-proyecto.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Predicciones para resolver el Problema de Ventas</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-referencias.html" class="sidebar-item-text sidebar-link">Referencias</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#serie-de-tiempo-total" id="toc-serie-de-tiempo-total" class="nav-link active" data-scroll-target="#serie-de-tiempo-total"><span class="toc-section-number">5.1</span>  Serie de tiempo total</a></li>
  <li><a href="#problema-en-series-jerárquicas" id="toc-problema-en-series-jerárquicas" class="nav-link" data-scroll-target="#problema-en-series-jerárquicas"><span class="toc-section-number">5.2</span>  Problema en series jerárquicas</a></li>
  <li><a href="#enfoque-ascendente-bottom-up" id="toc-enfoque-ascendente-bottom-up" class="nav-link" data-scroll-target="#enfoque-ascendente-bottom-up"><span class="toc-section-number">5.3</span>  Enfoque ascendente (bottom-up)</a></li>
  <li><a href="#enfoque-middle-out" id="toc-enfoque-middle-out" class="nav-link" data-scroll-target="#enfoque-middle-out"><span class="toc-section-number">5.4</span>  Enfoque middle-out</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Predicciones para resolver el Problema de Ventas</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Con el fin de ejemplificar la teoría y metodologías mencionadas en secciones anteriores, se procederá a resolver un problema de pronósticos de series de tiempo para las ventas de 4 productos en dos tipos de tiendas y a lo largo de diferentes países alrededor de Europa. El conjunto de datos empleado se encuentra en <a href="https://www.kaggle.com/competitions/tabular-playground-series-sep-2022/data">Kaggle</a>.</p>
<ul>
<li><p>Se abordará el problema como un serie jerárquica igual a la Figura 1 de la Sección 2.</p></li>
<li><p>El principal problema a resolver es que las prediciones en cada nivel jerárquico cuadren para una mejor toma de decisiones, por ejemplo, que la suma de los pronósticos de todas las tiendas en todos los países sea igual a la suma de los pronósticos de todos los países.</p></li>
</ul>
<section id="serie-de-tiempo-total" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="serie-de-tiempo-total"><span class="header-section-number">5.1</span> Serie de tiempo total</h2>
<p>Primero, supongamos que queremos pronosticar las ventas totales en toda la zona de Europa utilizando información de 2017 a 2020 a nivel mensual, y queremos realizar predicciones dos años hacia adelante, es decir, 24 periodos adicionales. Para ello, utilizaremos un <em>modelo de espacio de estados</em> con nivel local con tendencia y estacionalidad con 12 periodos (meses).</p>
<p>A continuación se muestra el ajuste con el modelo a través de <em>bsts</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> TS[[<span class="st">"total"</span>]]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste, <span class="st">"state"</span>, <span class="at">burn =</span> <span class="dv">2000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En la siguiente figura podemos ver la desagregación de la serie temporal en tendencia y estacionalidad. Podemos ver que la <em>tendencia</em> tiene un comportamiento como el descrito en la Sección 2 (Análisis de la tendencia) ya que con la pandemia se tuvo una caída abrupta en las ventas para todos los países durante el primer trimestre de 2020 y una tendencia de recuperación en el nivel de ventas posterior a ese trimestre. Para la <em>estacionalidad</em> también podemos ver un comportamiento similar y bien marcado como el de la Sección 2 (Análisis de estacionalidad).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>tiempo <span class="ot">&lt;-</span> dims[<span class="dv">3</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>contribuciones_tbl <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>tiempo, <span class="sc">~</span> ajuste<span class="sc">$</span>state.contributions[,,.x] <span class="sc">|&gt;</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> .x)) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(trend<span class="sc">:</span>seasonal.<span class="fl">12.1</span>, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"comp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t, comp) <span class="sc">|&gt;</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value), <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(contribuciones_tbl, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media, <span class="at">ymin =</span> q5, <span class="at">ymax =</span> q95)) <span class="sc">+</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span> comp, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos notar que no existe correlación al menos a un paso. Sin embargo, gracias al gráfico “Q-Q” podemos notar que existen errores grandes en algunos meses que no pudieron ser captados por la propuesta de modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pred_errors_tbl <span class="ot">&lt;-</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  ajuste<span class="sc">$</span>one.step.prediction.errors <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span> tiempo) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(t), <span class="at">names_to =</span> <span class="st">"sim"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">valor =</span> <span class="fu">mean</span>(valor)) <span class="sc">|&gt;</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> t)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ACF</span>(pred_errors_tbl) <span class="sc">|&gt;</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>error <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>one.step.prediction.errors <span class="sc">|&gt;</span> <span class="fu">apply</span>(<span class="dv">2</span>, mean)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(error)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(error)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finalmente, mostramos los pronósticos hechos a 24 meses hacia adelante, donde podemos ver que a mayor tiempo, el intervalo de confianza del pronóstico se amplía debido al aumento de la varianza.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">24</span>,<span class="at">burn=</span><span class="dv">2000</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="problema-en-series-jerárquicas" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="problema-en-series-jerárquicas"><span class="header-section-number">5.2</span> Problema en series jerárquicas</h2>
<p>Una vez con los pronósticos de la serie total de toda Europa, el negocio necesita saber el pronóstico para cada país, para cada tipo de tienda dentro de cada país, y para cada producto de cada tienda de cada país, con el fin de tomar acciones en casos de que alguna unidad de negocio tenga problemas con sus niveles de ventas. Para ello, se realizan ajustes con el mismo modelo de espacio de estados con nivel local con tendencia y estacionalidad con 12 periodos, aunque para todos los niveles de cada unidad de negocio.</p>
<p>Aquí es donde se presenta el principal problema de este tipo de series de tiempo, ya que la suma de todas las series por producto, tienda o país debería ser la misma que la serie total en toda Europa, lo cual no siempre pasa y llega a provocar dudas sobre cuál serie es la correcta y debería seguirse.</p>
<p>Lo anterior se ilustra en el siguiente gráfico que compara la serie total contra la suman de todas las series a nivel producto, tienda y país. La discrepancia se nota más cuando se realizan pronósticos en ventanas de tiempo no observadas (parte derecha a partir de la línea vertical punteada).</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p>Las 3 series presentadas sólo intentan ilustrar el problema de discrepancia, sin embargo, existen otras combinaciones en la jerarquía que tienen el mismo problema, por ejemplo, sumar todas las series de un producto de un país determinado contra la serie de ese mismo país.</p>
</div>
</div>
<div class="cell">
<details>
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> TS[[<span class="st">"total"</span>]]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>tiempo <span class="ot">&lt;-</span> dims[<span class="dv">3</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>contribuciones_total <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>tiempo, <span class="sc">~</span> ajuste<span class="sc">$</span>state.contributions[,,.x] <span class="sc">|&gt;</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> .x)) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(trend<span class="sc">:</span>seasonal.<span class="fl">12.1</span>, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"comp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t, comp) <span class="sc">|&gt;</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value), <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_total =</span> <span class="fu">sum</span>(media))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">24</span>,<span class="at">burn=</span><span class="dv">2000</span>)<span class="sc">$</span>mean</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>contribuciones_total<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_total,<span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">49</span><span class="sc">:</span><span class="dv">72</span>, <span class="at">media_total =</span> pred))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>i<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">unique</span>(sales_m<span class="sc">$</span>country)){</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(s <span class="cf">in</span> <span class="fu">unique</span>(sales<span class="sc">$</span>store)){</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(p <span class="cf">in</span> <span class="fu">unique</span>(sales<span class="sc">$</span>product)){</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      ajuste <span class="ot">&lt;-</span> TS[[<span class="fu">paste</span>(c,s,p,<span class="at">sep =</span> <span class="st">"_"</span>)]]</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      dims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      tiempo <span class="ot">&lt;-</span> dims[<span class="dv">3</span>]</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      contribuciones_tbl <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>tiempo, <span class="sc">~</span> ajuste<span class="sc">$</span>state.contributions[,,.x] <span class="sc">|&gt;</span> </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> .x)) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(trend<span class="sc">:</span>seasonal.<span class="fl">12.1</span>, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"comp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(t, comp) <span class="sc">|&gt;</span> </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value), <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">media_producto =</span> <span class="fu">sum</span>(media)) <span class="sc">|&gt;</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">paste</span>(c,s,p,<span class="at">sep =</span> <span class="st">"_"</span>))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">24</span>,<span class="at">burn=</span><span class="dv">2000</span>)<span class="sc">$</span>mean</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        contribuciones_tbl<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_tbl,<span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">49</span><span class="sc">:</span><span class="dv">72</span>, <span class="at">media_producto =</span> pred,<span class="at">p =</span> <span class="fu">paste</span>(c,s,p,<span class="at">sep =</span> <span class="st">"_"</span>)))</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">0</span>){contribuciones_producto<span class="ot">&lt;-</span>contribuciones_tbl}<span class="cf">else</span>{contribuciones_producto<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_producto,contribuciones_tbl)}</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        i<span class="ot">&lt;-</span>i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>contribuciones_producto_tbl<span class="ot">&lt;-</span>contribuciones_producto</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>contribuciones_producto<span class="ot">&lt;-</span>contribuciones_producto <span class="sc">|&gt;</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_producto =</span> <span class="fu">sum</span>(media_producto)) </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>i<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">unique</span>(sales_m<span class="sc">$</span>country)){</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(s <span class="cf">in</span> <span class="fu">unique</span>(sales<span class="sc">$</span>store)){</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    ajuste <span class="ot">&lt;-</span> TS[[<span class="fu">paste</span>(c,s,<span class="at">sep =</span> <span class="st">"_"</span>)]]</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    dims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    tiempo <span class="ot">&lt;-</span> dims[<span class="dv">3</span>]</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    contribuciones_tbl <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>tiempo, <span class="sc">~</span> ajuste<span class="sc">$</span>state.contributions[,,.x] <span class="sc">|&gt;</span> </span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> .x)) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(trend<span class="sc">:</span>seasonal.<span class="fl">12.1</span>, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"comp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(t, comp) <span class="sc">|&gt;</span> </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value), <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>                <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">media_store =</span> <span class="fu">sum</span>(media)) <span class="sc">|&gt;</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">paste</span>(c,s,<span class="at">sep =</span> <span class="st">"_"</span>))</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>      pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">24</span>,<span class="at">burn=</span><span class="dv">2000</span>)<span class="sc">$</span>mean</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>      contribuciones_tbl<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_tbl,<span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">49</span><span class="sc">:</span><span class="dv">72</span>, <span class="at">media_store =</span> pred,<span class="at">p =</span> <span class="fu">paste</span>(c,s,<span class="at">sep =</span> <span class="st">"_"</span>)))</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">0</span>){contribuciones_store<span class="ot">&lt;-</span>contribuciones_tbl}<span class="cf">else</span>{contribuciones_store<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_store,contribuciones_tbl)}</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>      i<span class="ot">&lt;-</span>i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>contribuciones_store_tbl<span class="ot">&lt;-</span>contribuciones_store</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>contribuciones_store<span class="ot">&lt;-</span>contribuciones_store <span class="sc">|&gt;</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_store =</span> <span class="fu">sum</span>(media_store)) </span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>i<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">unique</span>(sales_m<span class="sc">$</span>country)){</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  ajuste <span class="ot">&lt;-</span> TS[[<span class="fu">paste</span>(c,<span class="at">sep =</span> <span class="st">"_"</span>)]]</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  dims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  tiempo <span class="ot">&lt;-</span> dims[<span class="dv">3</span>]</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>  contribuciones_tbl <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>tiempo, <span class="sc">~</span> ajuste<span class="sc">$</span>state.contributions[,,.x] <span class="sc">|&gt;</span> </span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> .x)) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(trend<span class="sc">:</span>seasonal.<span class="fl">12.1</span>, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"comp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(t, comp) <span class="sc">|&gt;</span> </span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value), <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>              <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">media_country =</span> <span class="fu">sum</span>(media)) <span class="sc">|&gt;</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">paste</span>(c,<span class="at">sep =</span> <span class="st">"_"</span>))</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">24</span>,<span class="at">burn=</span><span class="dv">2000</span>)<span class="sc">$</span>mean</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    contribuciones_tbl<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_tbl,<span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">49</span><span class="sc">:</span><span class="dv">72</span>, <span class="at">media_country =</span> pred,<span class="at">p =</span> <span class="fu">paste</span>(c,<span class="at">sep =</span> <span class="st">"_"</span>)))</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">0</span>){contribuciones_country<span class="ot">&lt;-</span>contribuciones_tbl}<span class="cf">else</span>{contribuciones_country<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_country,contribuciones_tbl)}</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>    i<span class="ot">&lt;-</span>i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>contribuciones_country_tbl <span class="ot">&lt;-</span> contribuciones_country</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>contribuciones_country<span class="ot">&lt;-</span>contribuciones_country <span class="sc">|&gt;</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_country =</span> <span class="fu">sum</span>(media_country)) </span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>contribuciones_tbl<span class="ot">&lt;-</span><span class="fu">cbind</span>(</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>  contribuciones_total,</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>  contribuciones_producto<span class="sc">|&gt;</span><span class="fu">select</span>(media_producto),</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>  contribuciones_store <span class="sc">|&gt;</span><span class="fu">select</span>(media_store),</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>  contribuciones_country <span class="sc">|&gt;</span><span class="fu">select</span>(media_country)</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_total_producto =</span> media_total <span class="sc">-</span> media_producto,</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_total_store =</span> media_total <span class="sc">-</span> media_store,</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_total_country =</span> media_total <span class="sc">-</span> media_country</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>contribuciones_tbl_2<span class="ot">&lt;-</span>contribuciones_producto_tbl <span class="sc">|&gt;</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t,country) <span class="sc">|&gt;</span></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_producto =</span> <span class="fu">sum</span>(media_producto)) <span class="sc">|&gt;</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>contribuciones_tbl_2 <span class="ot">&lt;-</span> <span class="fu">merge</span>(contribuciones_tbl_2,contribuciones_country_tbl, <span class="at">by.x =</span> <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"country"</span>),<span class="at">by.y =</span><span class="fu">c</span>(<span class="st">"t"</span>, <span class="st">"p"</span>),<span class="at">all=</span><span class="cn">TRUE</span>) </span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>contribuciones_tbl_3<span class="ot">&lt;-</span>contribuciones_store_tbl <span class="sc">|&gt;</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t,country) <span class="sc">|&gt;</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media_store =</span> <span class="fu">sum</span>(media_store)) <span class="sc">|&gt;</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>contribuciones_tbl_3 <span class="ot">&lt;-</span> <span class="fu">merge</span>(contribuciones_tbl_3,contribuciones_country_tbl, <span class="at">by.x =</span> <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"country"</span>),<span class="at">by.y =</span><span class="fu">c</span>(<span class="st">"t"</span>, <span class="st">"p"</span>),<span class="at">all=</span><span class="cn">TRUE</span>) </span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>i<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">unique</span>(sales_m<span class="sc">$</span>country)){</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(s <span class="cf">in</span> <span class="fu">unique</span>(sales<span class="sc">$</span>store)){</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(p <span class="cf">in</span> <span class="fu">unique</span>(sales<span class="sc">$</span>product)){</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>      ajuste <span class="ot">&lt;-</span> TSp[[<span class="fu">paste</span>(c,s,p,<span class="at">sep =</span> <span class="st">"_"</span>)]]</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>      dims <span class="ot">&lt;-</span> ajuste<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>      tiempo <span class="ot">&lt;-</span> dims[<span class="dv">3</span>]</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>      contribuciones_p <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>tiempo, <span class="sc">~</span> ajuste<span class="sc">$</span>state.contributions[,,.x] <span class="sc">|&gt;</span> </span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> .x)) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(trend<span class="sc">:</span>seasonal.<span class="fl">12.1</span>, <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"comp"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(t, comp) <span class="sc">|&gt;</span> </span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value), <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>                  <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">media_producto =</span> <span class="fu">sum</span>(media)) <span class="sc">|&gt;</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">paste</span>(c,s,p,<span class="at">sep =</span> <span class="st">"_"</span>))</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">24</span>,<span class="at">burn=</span><span class="dv">2000</span>)<span class="sc">$</span>mean</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>        contribuciones_p<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_p,<span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">49</span><span class="sc">:</span><span class="dv">72</span>, <span class="at">media_producto =</span> pred,<span class="at">p =</span> <span class="fu">paste</span>(c,s,p,<span class="at">sep =</span> <span class="st">"_"</span>)))</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">0</span>){contribuciones_p_producto<span class="ot">&lt;-</span>contribuciones_p}<span class="cf">else</span>{contribuciones_p_producto<span class="ot">&lt;-</span><span class="fu">rbind</span>(contribuciones_p_producto,contribuciones_p)}</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>        i<span class="ot">&lt;-</span>i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>pp1<span class="ot">&lt;-</span>contribuciones_producto_tbl <span class="sc">|&gt;</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Poland"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="st">"KaggleMart"</span>) </span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>pp2<span class="ot">&lt;-</span>contribuciones_store_tbl <span class="sc">|&gt;</span></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Poland"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="st">"KaggleMart"</span>) </span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>pp3<span class="ot">&lt;-</span>contribuciones_p_producto <span class="sc">|&gt;</span></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Poland"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="st">"KaggleMart"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t,country,store) <span class="sc">|&gt;</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_all =</span> <span class="fu">sum</span>(media_producto)) <span class="sc">|&gt;</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">media_producto =</span> media_producto<span class="sc">/</span>p_all)</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>pp4<span class="ot">&lt;-</span><span class="fu">merge</span>(pp2,pp3, <span class="at">by =</span>  <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"country"</span>,<span class="st">"store"</span>),<span class="at">all=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">media_producto=</span><span class="fu">round</span>(media_producto<span class="sc">*</span>media_store,<span class="dv">0</span>))</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>pp4<span class="ot">&lt;-</span><span class="fu">merge</span>(pp4,pp1, <span class="at">by =</span>  <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">all=</span><span class="cn">TRUE</span>,<span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">"_proportion"</span>,<span class="st">"_serie"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>() </span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>ppp1<span class="ot">&lt;-</span>contribuciones_producto_tbl <span class="sc">|&gt;</span></span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Germany"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="st">"KaggleRama"</span>) </span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>ppp2<span class="ot">&lt;-</span>contribuciones_store_tbl <span class="sc">|&gt;</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Germany"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="st">"KaggleRama"</span>) </span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>ppp3<span class="ot">&lt;-</span>contribuciones_p_producto <span class="sc">|&gt;</span></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(p, <span class="fu">c</span>(<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="st">"Germany"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="st">"KaggleRama"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t,country,store) <span class="sc">|&gt;</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_all =</span> <span class="fu">sum</span>(media_producto)) <span class="sc">|&gt;</span></span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">media_producto =</span> media_producto<span class="sc">/</span>p_all)</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>ppp4<span class="ot">&lt;-</span><span class="fu">merge</span>(ppp2,ppp3, <span class="at">by =</span>  <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"country"</span>,<span class="st">"store"</span>),<span class="at">all=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">media_producto=</span><span class="fu">round</span>(media_producto<span class="sc">*</span>media_store,<span class="dv">0</span>))</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>ppp4<span class="ot">&lt;-</span><span class="fu">merge</span>(ppp4,ppp1, <span class="at">by =</span>  <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"country"</span>,<span class="st">"store"</span>,<span class="st">"product"</span>),<span class="at">all=</span><span class="cn">TRUE</span>,<span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">"_proportion"</span>,<span class="st">"_serie"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>() </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(contribuciones_tbl)<span class="sc">+</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> diff_total_producto<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Total - Producto"</span>)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> diff_total_store<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Total - Store"</span>)) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> diff_total_country<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Total - Country"</span>)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>) <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Diferencias"</span>, <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total - Producto"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>,<span class="st">"Total - Store"</span> <span class="ot">=</span> <span class="st">"#218611"</span>,<span class="st">"Total - Country"</span> <span class="ot">=</span><span class="st">"#77091b"</span>)) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="enfoque-ascendente-bottom-up" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="enfoque-ascendente-bottom-up"><span class="header-section-number">5.3</span> Enfoque ascendente (bottom-up)</h2>
<p>Utilizando este enfoque se ajustan todas las series de tiempo del nivel más bajo, en este caso de los productos de todas las tiendas de todos los países, lo que implica que para este enfoque <strong>se tienen que ajustar 48 series de tiempo</strong> y posteriormente sumarlas para obtener los pronósticos de cualquiera de los niveles hacia arriba.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(contribuciones_tbl)<span class="sc">+</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_total<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Total"</span>) ) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_producto<span class="sc">/</span><span class="dv">1000</span>, <span class="at">colour =</span> <span class="st">"Producto"</span>),<span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Serie Jerárquica"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Total"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Producto"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>)) <span class="sc">+</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(contribuciones_tbl_2)<span class="sc">+</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_country<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Country"</span>) ) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_producto<span class="sc">/</span><span class="dv">1000</span>, <span class="at">colour =</span> <span class="st">"Producto"</span>),<span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Serie Jerárquica"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Country"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Producto"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>)) <span class="sc">+</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(country), <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="enfoque-middle-out" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="enfoque-middle-out"><span class="header-section-number">5.4</span> Enfoque middle-out</h2>
<p>El problema con el enfoque anterior es que el nivel más bajo de la serie jerárquica podría ser altamente ruidoso y no todos los nodos podrían tener la suficiente información disponible para hacer un ajuste o predicción, además de que al ser el nivel más bajo el número de series a ajustar podría ser muy amplio. Por lo tanto, utilizaremos un enfoque que combina <em>bottom-up</em> y <em>top-down</em> usando un nivel de la serie de tiempo lo suficientemente robusto como para obtener pronósticos adeacuados además de ajustar una menor cantidad de series de tiempo.</p>
<p>Utilizaremos el nivel de <em>store</em> para ajustar sólo <strong>12 series de tiempo</strong>. Para los niveles hacia arriba usaremos el enfoque <em>bottom-up</em>, es decir, para país y total; mientras que para los niveles hacia abajo usaremos el enfoque <em>top-down</em> con forecast de proporciones, es decir, para producto.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(contribuciones_tbl)<span class="sc">+</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_total<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Total"</span>) ) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_store<span class="sc">/</span><span class="dv">1000</span>, <span class="at">colour =</span> <span class="st">"Store"</span>),<span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Serie Jerárquica"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Total"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Store"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>)) <span class="sc">+</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(contribuciones_tbl_3)<span class="sc">+</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_country<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Country"</span>) ) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_store<span class="sc">/</span><span class="dv">1000</span>, <span class="at">colour =</span> <span class="st">"Store"</span>),<span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Serie Jerárquica"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Country"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Store"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>)) <span class="sc">+</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(country), <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p>Para los pronósticos de las proporciones de cada producto por tienda por país, se normalizó con el fin de que sumen 1, además de que se redondeó el pronóstico, ya que las ventas son valores enteros.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pp4)<span class="sc">+</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_producto_serie<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Producto"</span>) ) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_producto_proportion<span class="sc">/</span><span class="dv">1000</span>, <span class="at">colour =</span> <span class="st">"Store"</span>),<span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>, <span class="at">title =</span> <span class="st">"Poland &amp; KaggleMart"</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Serie Jerárquica"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Producto"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Store"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>)) <span class="sc">+</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(product), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ppp4)<span class="sc">+</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_producto_serie<span class="sc">/</span><span class="dv">1000</span>,<span class="at">colour =</span> <span class="st">"Producto"</span>) ) <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> media_producto_proportion<span class="sc">/</span><span class="dv">1000</span>, <span class="at">colour =</span> <span class="st">"Store"</span>),<span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"t"</span>, <span class="at">y =</span> <span class="st">"sales (miles)"</span>, <span class="at">title =</span> <span class="st">"Germany &amp; KaggleRama"</span>) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Serie Jerárquica"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Producto"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Store"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>)) <span class="sc">+</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">48</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(product), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05-proyecto_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./04-proyecto.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Reconciliación en las Predicciones</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./99-referencias.html" class="pagination-link">
        <span class="nav-page-text">Referencias</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>